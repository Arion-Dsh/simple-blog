define("lib/upload",["$"],function(a,b,c){function d(a){if(!(this instanceof d))return new d(a);e(a)&&(a={trigger:a});var b={trigger:null,name:null,action:null,data:null,accept:null,change:null,error:null,success:null};a&&j.extend(b,a);var c=j(b.trigger);b.action=b.action||c.data("action")||"/upload",b.name=b.name||c.data("name")||"file",b.data=b.data||g(c.data("data")),b.accept=b.accept||c.data("accept"),b.success=b.success||c.data("success"),this.settings=b,this.setup(),this.bind()}function e(a){return"[object String]"===Object.prototype.toString.call(a)}function f(a){if(!a)return[];var b,c=[];for(var d in a)b=document.createElement("input"),b.type="hidden",b.name=d,b.value=a[d],c.push(b);return c}function g(a){if(!a)return{};for(var b={},c=a.split("&"),d=function(a){return decodeURIComponent(a.replace(/\+/g," "))},e=0;e<c.length;e++){var f=c[e].split("="),g=d(f[0]),h=d(f[1]);b[g]=h}return b}function h(a){for(var b=a.parentsUntil("body"),c=0,d=0;d<b.length;d++){var e=b.eq(d);"static"!==e.css("position")&&(c=parseInt(e.css("zIndex"),10)||c)}return c}function i(a){if(!(this instanceof i))return new i(a);e(a)&&(a={trigger:a});var b=j(a.trigger),c=[];b.each(function(b,e){a.trigger=e,c.push(new d(a))}),this._uploaders=c}var j=a("$"),k=0;d.prototype.setup=function(){var a="iframe-uploader-"+k;this.iframe=j('<iframe name="'+a+'" />').hide(),k+=1,this.form=j('<form method="post" enctype="multipart/form-data"target="'+a+'" '+'action="'+this.settings.action+'" />');var b=this.settings.data;if(this.form.append(f(b)),window.FormData){this._formdata=new FormData;for(var c in b)this._formdata.append(c,b[c]);this._formdata.append("_uploader_","formdata")}else this.form.append(f({_uploader_:"iframe"}));var d=document.createElement("input");d.type="file",d.name=this.settings.name,this.settings.accept&&(d.accept=this.settings.accept),this.input=j(d);var e=j(this.settings.trigger);return this.input.attr("hidefocus",!0).css({position:"absolute",top:0,right:0,opacity:0,outline:0,cursor:"pointer",height:e.outerHeight(),fontSize:Math.max(64,5*e.outerHeight())}),this.form.append(this.input),this.form.css({position:"absolute",top:e.offset().top,left:e.offset().left,overflow:"hidden",width:e.outerWidth(),height:e.outerHeight(),zIndex:h(e)+10}).appendTo("body"),this},d.prototype.bind=function(){var a=this,b=j(a.settings.trigger);b.mouseenter(function(){a.form.css({top:b.offset().top,left:b.offset().left,width:b.outerWidth(),height:b.outerHeight()})}),a.bindInput()},d.prototype.bindInput=function(){var a=this;a.input.change(function(){a._files=this.files;var b=a.input.val();if(a.settings.change)b&&(b=b.substr(b.lastIndexOf("\\")+1)),a.settings.change(b);else if(b)return a.submit()})},d.prototype.submit=function(){var a=this;if(a._formdata&&a._files){var b=new FormData(a._formdata);return j.each(a._files,function(c,d){b.append(a.settings.name,d)}),j.ajax({url:a.settings.action,type:"post",processData:!1,contentType:!1,data:b,context:this,success:a.settings.success,error:a.settings.error}),this}return j("body").append(a.iframe),a.iframe.on("load",function(){var b=a.iframe.contents().find("body").html();a.iframe.off("load").remove(),b?a.settings.success&&a.settings.success(b):a.settings.error&&a.settings.error(a.input.val())}),a.form.submit(),this},d.prototype.refreshInput=function(){var a=this.input.clone();this.input.before(a),this.input.off("change"),this.input.remove(),this.input=a,this.bindInput()},d.prototype.change=function(a){return a?(this.settings.change=a,this):this},d.prototype.success=function(a){return this.settings.success=function(b){this.refreshInput(),a&&a(b)},this},d.prototype.error=function(a){return this.settings.error=function(){a&&(this.refreshInput(),a(response))},this},i.prototype.submit=function(){return j.each(this._uploaders,function(a,b){b.submit()}),this},i.prototype.change=function(a){return j.each(this._uploaders,function(b,c){c.change(a)}),this},i.prototype.success=function(a){return j.each(this._uploaders,function(b,c){c.success(a)}),this},i.prototype.error=function(a){return j.each(this._uploaders,function(b,c){c.error(a)}),this},i.Uploader=d,c.exports=i});
